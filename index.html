<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reparto de gastos por partes</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2e;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#22304a;
      --accent:#22c55e;
      --accent2:#ef4444;
      --accent3:#eab308;
      --shadow:0 14px 40px rgba(0,0,0,.45);
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: transparent;
      color:var(--text);
      padding:18px;
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      display:grid;
      gap:14px;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      padding:16px 18px;
      border:1px solid var(--border);
      background: #0f172a;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    header .title{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .sub{
      margin:0;
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
    }
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      font-weight:600;
      letter-spacing:.2px;
    }
    button:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.14); }
    button:active{ transform: translateY(1px); }
    .btn-primary{
      background: linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.10));
      border-color: rgba(34,197,94,.35);
    }
    .btn-primary:hover{ border-color: rgba(34,197,94,.55); background: linear-gradient(180deg, rgba(34,197,94,.28), rgba

(34,197,94,.12)); }
    .btn-plus{
      font-size:16px;
      width:44px;
      height:44px;
      display:inline-grid;
      place-items:center;
      padding:0;
    }
    .btn-danger{
      background: linear-gradient(180deg, rgba(239,68,68,.22), rgba(239,68,68,.10));
      border-color: rgba(239,68,68,.35);
    }
    .btn-danger:hover{ border-color: rgba(239,68,68,.55); }
    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background: #0f172a;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      font-size:14px;
      letter-spacing:.3px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .body{ padding:14px; }
    .table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.07);
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:left;
      font-size:13px;
    }
    .table th{
      color:var(--muted);
      font-weight:700;
      background: rgba(255,255,255,.02);
    }
    .table tr:last-child td{ border-bottom:none; }
    input{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    input::placeholder{ color: rgba(229,231,235,.45); }
    input:focus{ border-color: rgba(34,197,94,.45); box-shadow: 0 0 0 3px rgba(34,197,94,.12); }
    .row-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      font-size:12.5px;
      color:var(--muted);
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 920px){
      .grid2{ grid-template-columns: 1fr 1fr; }
    }
    .kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .kpi{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      border-radius:14px;
      padding:10px 12px;
    }
    .kpi .label{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    .kpi .val{ font-size:16px; font-weight:800; letter-spacing:.2px; }
    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .item{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .item .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .item .name{
      font-weight:800;
      font-size:13.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 62vw;
    }
    .item .meta{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .badge{
      font-size:12px;
      font-weight:800;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      white-space:nowrap;
    }
    .badge.pay{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.35); color: #fecaca; }
    .badge.get{ background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.35); color: #bbf7d0; }
    .badge.eq{  background: rgba(234,179,8,.10); border-color: rgba(234,179,8,.35); color: #fde68a; }
    .notice{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.12);
      color: var(--muted);
      font-size:12.5px;
      line-height:1.4;
    }
    .error{
      border-color: rgba(239,68,68,.5)!important;
      box-shadow: 0 0 0 3px rgba(239,68,68,.12)!important;
    }
    .small{
      font-size:12px;
      color:var(--muted);
    }
    footer{
      text-align:center;
      color:rgba(156,163,175,.75);
      font-size:12px;
      padding:4px 0 10px;
    }

    dialog{
      border:none;
      padding:0;
      background: transparent;
    }
    dialog::backdrop{
      background: rgba(0,0,0,.55);
    }
    .modal{
      width:min(880px, calc(100vw - 24px));
      border:1px solid rgba(255,255,255,.10);
      background: rgba(17,26,46,.92);
      backdrop-filter: blur(10px);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    .modal-title{
      font-weight:900;
      letter-spacing:.2px;
      font-size:14px;
    }
    .modal-body{
      padding:14px;
      display:grid;
      gap:12px;
    }
    .modal-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 860px){
      .modal-grid{
        grid-template-columns: 340px 1fr;
        align-items:start;
      }
    }
    .box{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
      overflow:hidden;
    }
    .box-h{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-weight:800;
      font-size:12.5px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .box-b{
      padding:12px;
      display:grid;
      gap:10px;
    }
    select{
      width:100%;
      padding:10px 10px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      font-size:13px;
    }
    textarea{
      width:100%;
      min-height: 280px;
      resize: vertical;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      font-size:12.5px;
      line-height:1.35;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre;
    }
    textarea:focus, select:focus{
      border-color: rgba(34,197,94,.45);
      box-shadow: 0 0 0 3px rgba(34,197,94,.12);
    }
    .modal-actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-end;
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, transparent, rgba(255,255,255,.03));
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>üßÆ Reparto de gastos por "partes"  üí∏ ‚öñÔ∏è</h1>
        <p class="sub">
          Introduce participantes, cu√°ntas partes asume cada uno y cu√°nto ha pagado. Pulsa <strong>Calcular</strong> para ver 

qui√©n debe abonar/cobrar y una propuesta de transferencias m√≠nimas.
        </p>
      </div>
      <div class="actions">
        <button class="btn-plus" id="btnAdd" title="A√±adir participante">+</button>
        <button class="btn-primary" id="btnCalc">Calcular</button>
        <button id="btnSaveCopy" title="Guarda los resultados y los copia al portapapeles">Guardar + Copiar</button>
        <button id="btnImport" title="Importa un archivo guardado (lista), y permite editar o borrar">Importar</button>
        <button class="btn-danger" id="btnReset" title="Limpiar todo">Reset</button>
      </div>
    </header>

    <section class="card">
      <h2>
        Participantes
        <span class="pill" id="pillCount">0 participantes</span>
      </h2>
      <div class="body">
        <table class="table" aria-label="Tabla de participantes">
          <thead>
            <tr>
              <th style="width:42%">Nombre</th>
              <th style="width:18%">Partes</th>
              <th style="width:22%">Pagado (‚Ç¨)</th>
              <th style="width:18%; text-align:right;">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="notice">
          <strong>C√≥mo funciona:</strong> el coste por parte se calcula como <em>Total pagado / Total partes</em>.  
          A cada participante le corresponde <em>Partes √ó coste por parte</em>. Si ha pagado m√°s, <strong>cobra</strong>; si 

ha pagado menos, <strong>abona</strong>.
        </div>
      </div>
    </section>

    <div class="grid2">
      <section class="card">
        <h2>Resultados por participante</h2>
        <div class="body">
          <div class="kpis">
            <div class="kpi">
              <div class="label">Total pagado</div>
              <div class="val" id="kpiTotal">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="label">Total partes</div>
              <div class="val" id="kpiParts">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="label">Coste por parte</div>
              <div class="val" id="kpiUnit">‚Äî</div>
            </div>
          </div>

          <div class="list" id="resultList" style="margin-top:12px;"></div>
          <div class="small" id="roundingNote" style="margin-top:10px;"></div>
        </div>
      </section>

      <section class="card">
        <h2>Qui√©n paga a qui√©n (transferencias m√≠nimas)</h2>
        <div class="body">
          <div class="list" id="txList"></div>
          <div class="notice" id="txNote" style="display:none;"></div>
        </div>
      </section>
    </div>

    <footer>App local (un solo HTML). No env√≠a datos a internet.</footer>
  </div>

  <dialog id="importDlg" aria-label="Importar y gestionar archivos guardados">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">Importar / Editar / Borrar archivos guardados</div>
        <button id="btnCloseImport" type="button" title="Cerrar">Cerrar</button>
      </div>

      <div class="modal-body">
        <div class="modal-grid">
          <div class="box">
            <div class="box-h">
              <span>Archivos guardados</span>
              <span class="small" id="savedCount">0</span>
            </div>
            <div class="box-b">
              <select id="savedSelect" size="10" aria-label="Lista de archivos guardados"></select>
              <div class="small" id="savedMeta">Selecciona un archivo para ver su contenido.</div>
            </div>
          </div>

          <div class="box">
            <div class="box-h">
              <span>Contenido (editable)</span>
              <span class="small">TSV</span>
            </div>
            <div class="box-b">
              <textarea id="savedEditor" placeholder="Selecciona un archivo..."></textarea>
              <div class="small" id="importHint">
                Puedes editar el contenido y guardar cambios. Tambi√©n puedes cargarlo en la app (se restauran: Nombre, Partes, 

Pagado).
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button id="btnLoadToApp" class="btn-primary" type="button" title="Carga este archivo en la app para seguir 

editando/rec√°lculo">Cargar en app</button>
        <button id="btnSaveEdits" type="button" title="Guarda los cambios del contenido editado">Guardar cambios</button>
        <button id="btnDeleteSaved" class="btn-danger" type="button" title="Borra el archivo seleccionado">Borrar</button>
      </div>
    </div>
  </dialog>

  <script>
    // ===============================
    // Utilidades
    // ===============================
    const fmtEUR = (n) => {
      if (!Number.isFinite(n)) return '‚Äî';
      return n.toLocaleString('es-ES', { style:'currency', currency:'EUR' });
    };

    const round2 = (n) => Math.round((n + Number.EPSILON) * 100) / 100;

    const parseNum = (v) => {
      if (typeof v !== 'string') return Number(v);
      const cleaned = v.trim().replace(/\s/g,'').replace(',', '.');
      const num = Number(cleaned);
      return Number.isFinite(num) ? num : NaN;
    };

    const escapeHTML = (s) => String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");

    function apportionToCents(rawTargets, total) {
      const centsTotal = Math.round(total * 100);

      const floors = rawTargets.map(v => Math.floor(v * 100));
      let sumFloor = floors.reduce((a,b)=>a+b,0);

      const remainders = rawTargets.map((v,i)=>({
        i,
        r: (v * 100) - floors[i]
      })).sort((a,b)=> b.r - a.r);

      let missing = centsTotal - sumFloor;
      const out = floors.slice();

      for (let k=0; k<remainders.length && missing>0; k++){
        out[remainders[k].i] += 1;
        missing--;
      }
      return out.map(c => c/100);
    }

    // ===============================
    // DOM
    // ===============================
    const DOM = {
      tbody: document.getElementById('tbody'),
      btnAdd: document.getElementById('btnAdd'),
      btnCalc: document.getElementById('btnCalc'),
      btnSaveCopy: document.getElementById('btnSaveCopy'),
      btnImport: document.getElementById('btnImport'),
      btnReset: document.getElementById('btnReset'),
      pillCount: document.getElementById('pillCount'),
      kpiTotal: document.getElementById('kpiTotal'),
      kpiParts: document.getElementById('kpiParts'),
      kpiUnit: document.getElementById('kpiUnit'),
      resultList: document.getElementById('resultList'),
      txList: document.getElementById('txList'),
      txNote: document.getElementById('txNote'),
      roundingNote: document.getElementById('roundingNote'),

      importDlg: document.getElementById('importDlg'),
      btnCloseImport: document.getElementById('btnCloseImport'),
      savedSelect: document.getElementById('savedSelect'),
      savedEditor: document.getElementById('savedEditor'),
      savedCount: document.getElementById('savedCount'),
      savedMeta: document.getElementById('savedMeta'),
      btnLoadToApp: document.getElementById('btnLoadToApp'),
      btnSaveEdits: document.getElementById('btnSaveEdits'),
      btnDeleteSaved: document.getElementById('btnDeleteSaved'),
    };

    window.__lastReportText = '';
    window.__lastReportReady = false;

    // ===============================
    // File System Access (carpeta vinculada)
    // ===============================
    const FS_HANDLE_KEY = 'reparto_gastos_dirhandle_v1';

    function hasFSAccessAPI() {
      return !!(window.showDirectoryPicker && window.showSaveFilePicker);
    }

    async function persistDirHandle(handle) {
      try {
        localStorage.setItem(FS_HANDLE_KEY, '__has_handle__');
        window.__dirHandle = handle;
        return true;
      } catch (_) {
        return false;
      }
    }

    async function ensureDirHandle(interactiveReasonText) {
      if (!hasFSAccessAPI()) return null;
      if (window.__dirHandle) return window.__dirHandle;

      const ok = confirm(interactiveReasonText || 'Selecciona la carpeta donde quieres guardar/leer los archivos (.tsv).');
      if (!ok) return null;

      try {
        const dir = await window.showDirectoryPicker({ mode: 'readwrite' });
        await persistDirHandle(dir);
        return dir;
      } catch (_) {
        return null;
      }
    }

    async function verifyDirPermission(dirHandle, mode='readwrite') {
      if (!dirHandle) return false;
      try {
        const opts = { mode };
        if (typeof dirHandle.queryPermission === 'function') {
          const q = await dirHandle.queryPermission(opts);
          if (q === 'granted') return true;
        }
        if (typeof dirHandle.requestPermission === 'function') {
          const r = await dirHandle.requestPermission(opts);
          return r === 'granted';
        }
        return true;
      } catch (_) {
        return false;
      }
    }

    // mapa filename -> FileHandle
    window.__dirFileHandleMap = new Map();
    function getMappedFileHandle(filename) {
      try {
        if (window.__dirFileHandleMap && window.__dirFileHandleMap.has(filename)) {
          return window.__dirFileHandleMap.get(filename);
        }
      } catch (_) {}
      return null;
    }
    function setMappedFileHandle(filename, handle) {
      try {
        if (!window.__dirFileHandleMap) window.__dirFileHandleMap = new Map();
        window.__dirFileHandleMap.set(filename, handle);
      } catch (_) {}
    }
    function deleteMappedFileHandle(filename) {
      try {
        if (window.__dirFileHandleMap) window.__dirFileHandleMap.delete(filename);
      } catch (_) {}
    }

    // ====== NUEVO (m√≠nimo): cache en memoria filename -> {text, ts} para que cambiar selecci√≥n no dependa de re-lecturas 

======
    window.__dirFileTextMap = new Map();
    function setCachedText(name, text, ts) {
      try {
        if (!window.__dirFileTextMap) window.__dirFileTextMap = new Map();
        window.__dirFileTextMap.set(name, { text: String(text ?? ''), ts: Number.isFinite(ts) ? ts : Date.now() });
      } catch (_) {}
    }
    function getCachedText(name) {
      try {
        if (window.__dirFileTextMap && window.__dirFileTextMap.has(name)) {
          return window.__dirFileTextMap.get(name);
        }
      } catch (_) {}
      return null;
    }
    function deleteCachedText(name) {
      try {
        if (window.__dirFileTextMap) window.__dirFileTextMap.delete(name);
      } catch (_) {}
    }

    // ===============================
    // Almacenamiento local fallback (lista interna)
    // ===============================
    const STORAGE_KEY = 'reparto_gastos_saved_reports_v1';

    function loadSavedIndex() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr
          .filter(x => x && typeof x.name === 'string' && typeof x.text === 'string')
          .map(x => ({
            name: x.name,
            text: x.text,
            ts: Number.isFinite(x.ts) ? x.ts : Date.now()
          }))
          .sort((a,b)=> (b.ts||0) - (a.ts||0));
      } catch (_) {
        return [];
      }
    }

    function saveSavedIndex(arr) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
        return true;
      } catch (_) {
        return false;
      }
    }

    function upsertSaved(name, text) {
      const now = Date.now();
      const arr = loadSavedIndex();
      const idx = arr.findIndex(x => x.name === name);
      if (idx >= 0) {
        arr[idx] = { name, text, ts: now };
      } else {
        arr.unshift({ name, text, ts: now });
      }
      return saveSavedIndex(arr);
    }

    function deleteSaved(name) {
      const arr = loadSavedIndex().filter(x => x.name !== name);
      return saveSavedIndex(arr);
    }

    function getSavedByName(name) {
      const arr = loadSavedIndex();
      return arr.find(x => x.name === name) || null;
    }

    // ===============================
    // Gesti√≥n de filas
    // ===============================
    function addRow({name='', parts=1, paid=0} = {}) {
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>
          <input class="inp-name" type="text" placeholder="Nombre" value="${escapeHTML(name)}" />
        </td>
        <td>
          <input class="inp-parts" type="number" min="0" step="1" placeholder="1" value="${escapeHTML(parts)}" />
        </td>
        <td>
          <input class="inp-paid" type="text" inputmode="decimal" placeholder="0,00" value="${escapeHTML(paid)}" />
        </td>
        <td style="text-align:right;">
          <div class="row-actions">
            <button class="btn-danger btn-del" type="button" title="Eliminar">Eliminar</button>
          </div>
        </td>
      `;

      tr.querySelector('.btn-del').addEventListener('click', () => {
        tr.remove();
        updateCount();
      });

      DOM.tbody.appendChild(tr);
      updateCount();
    }

    function updateCount() {
      const n = DOM.tbody.querySelectorAll('tr').length;
      DOM.pillCount.textContent = `${n} participante${n===1?'':'s'}`;
    }

    function clearOutputs() {
      DOM.kpiTotal.textContent = '‚Äî';
      DOM.kpiParts.textContent = '‚Äî';
      DOM.kpiUnit.textContent = '‚Äî';
      DOM.resultList.innerHTML = '';
      DOM.txList.innerHTML = '';
      DOM.txNote.style.display = 'none';
      DOM.txNote.textContent = '';
      DOM.roundingNote.textContent = '';
      window.__lastReportText = '';
      window.__lastReportReady = false;
    }

    function resetAll() {
      DOM.tbody.innerHTML = '';
      clearOutputs();
      addRow({name:'', parts:1, paid:0});
      addRow({name:'', parts:1, paid:0});
      addRow({name:'', parts:1, paid:0});
    }

    // ===============================
    // C√°lculo principal
    // ===============================
    function collectParticipants() {
      const rows = [...DOM.tbody.querySelectorAll('tr')];
      const participants = [];
      let hasError = false;

      rows.forEach(r => r.querySelectorAll('input').forEach(inp => inp.classList.remove('error')));

      rows.forEach((r, idx) => {
        const nameInp  = r.querySelector('.inp-name');
        const partsInp = r.querySelector('.inp-parts');
        const paidInp  = r.querySelector('.inp-paid');

        const name = (nameInp.value || '').trim();
        const parts = parseNum(partsInp.value);
        const paid = parseNum(paidInp.value);

        if (!name) { nameInp.classList.add('error'); hasError = true; }
        if (!Number.isFinite(parts) || parts <= 0) { partsInp.classList.add('error'); hasError = true; }
        if (!Number.isFinite(paid) || paid < 0) { paidInp.classList.add('error'); hasError = true; }

        participants.push({
          idx,
          name: name || `(Sin nombre ${idx+1})`,
          parts: Number.isFinite(parts) ? parts : 0,
          paid: Number.isFinite(paid) ? paid : 0,
        });
      });

      return { participants, hasError };
    }

    function buildReportText({ enriched, txs, totalPaid2, totalParts, unit2 }) {
      const now = new Date();
      const stamp = now.toLocaleString('es-ES');

      const lines = [];
      lines.push(`# Reparto de gastos por partes`);
      lines.push(`# Generado: ${stamp}`);
      lines.push(`# Total pagado\t${totalPaid2.toFixed(2)}`);
      lines.push(`# Total partes\t${totalParts}`);
      lines.push(`# Coste por parte (informativo)\t${unit2.toFixed(2)}`);
      lines.push('');

      lines.push('RESULTADOS_POR_PARTICIPANTE');
      lines.push(['Nombre','Partes','Pagado','Le_toca','Balance','Estado'].join('\t'));
      enriched.forEach(p => {
        const estado = (p.balance > 0.004) ? 'COBRA' : (p.balance < -0.004 ? 'ABONA' : 'CUADRADO');
        lines.push([
          p.name,
          String(p.parts),
          p.paid2.toFixed(2),
          p.shouldPay.toFixed(2),
          p.balance.toFixed(2),
          estado
        ].join('\t'));
      });

      lines.push('');
      lines.push('QUIEN_PAGA_A_QUIEN');
      if (!txs || txs.length === 0) {
        lines.push('No hacen falta transferencias.');
      } else {
        lines.push(['De','A','Importe'].join('\t'));
        txs.forEach(t => {
          lines.push([t.from, t.to, t.amount.toFixed(2)].join('\t'));
        });
      }

      lines.push('');
      lines.push('# Nota: formato TSV (tabuladores) para pegar en Excel.');

      return lines.join('\n');
    }

    function calculate() {
      clearOutputs();

      const { participants, hasError } = collectParticipants();
      if (participants.length === 0) {
        DOM.txNote.style.display = 'block';
        DOM.txNote.textContent = 'A√±ade al menos un participante.';
        return;
      }
      if (hasError) {
        DOM.txNote.style.display = 'block';
        DOM.txNote.textContent = 'Revisa los campos marcados en rojo (nombre obligatorio, partes > 0, pagado ‚â• 0).';
        return;
      }

      const totalPaid = participants.reduce((a,p)=>a+p.paid,0);
      const totalParts = participants.reduce((a,p)=>a+p.parts,0);

      if (totalParts <= 0) {
        DOM.txNote.style.display = 'block';
        DOM.txNote.textContent = 'El total de partes debe ser mayor que 0.';
        return;
      }

      const unitRaw = totalPaid / totalParts;
      const targetsRaw = participants.map(p => p.parts * unitRaw);

      const totalPaid2 = round2(totalPaid);
      const targets = apportionToCents(targetsRaw, totalPaid2);
      const unit2 = totalParts ? round2(totalPaid2 / totalParts) : 0;

      const enriched = participants.map((p,i) => {
        const shouldPay = targets[i];
        const paid2 = round2(p.paid);
        const balance = round2(paid2 - shouldPay);
        return { ...p, paid2, shouldPay, balance };
      });

      DOM.kpiTotal.textContent = fmtEUR(totalPaid2);
      DOM.kpiParts.textContent = String(totalParts);
      DOM.kpiUnit.textContent = fmtEUR(unit2);

      DOM.roundingNote.textContent =
        `Nota: se ajustan c√©ntimos para que la suma de ‚ÄúLe toca pagar‚Äù sea exactamente ${fmtEUR(totalPaid2)}.`;

      enriched
        .slice()
        .sort((a,b)=> b.balance - a.balance)
        .forEach(p => {
          const badgeClass = p.balance > 0.004 ? 'get' : (p.balance < -0.004 ? 'pay' : 'eq');
          const label = p.balance > 0.004
            ? `Cobra ${fmtEUR(Math.abs(p.balance))}`
            : (p.balance < -0.004 ? `Abona ${fmtEUR(Math.abs(p.balance))}` : 'Cuadrado');

          const meta = `Partes: ${p.parts} ¬∑ Pagado: ${fmtEUR(p.paid2)} ¬∑ Le toca: ${fmtEUR(p.shouldPay)}`;

          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <div class="left">
              <div class="name">${escapeHTML(p.name)}</div>
              <div class="meta">${escapeHTML(meta)}</div>
            </div>
            <div class="badge ${badgeClass}">${escapeHTML(label)}</div>
          `;
          DOM.resultList.appendChild(div);
        });

      const creditors = enriched
        .filter(p => p.balance > 0.004)
        .map(p => ({ name: p.name, amount: round2(p.balance) }))
        .sort((a,b)=> b.amount - a.amount);

      const debtors = enriched
        .filter(p => p.balance < -0.004)
        .map(p => ({ name: p.name, amount: round2(-p.balance) }))
        .sort((a,b)=> b.amount - a.amount);

      let txs = [];

      if (creditors.length === 0 && debtors.length === 0) {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="left">
            <div class="name">Todo cuadrado</div>
            <div class="meta">No hacen falta transferencias.</div>
          </div>
          <div class="badge eq">0,00 ‚Ç¨</div>
        `;
        DOM.txList.appendChild(div);
        DOM.txNote.style.display = 'block';
        DOM.txNote.textContent = 'Todos han pagado exactamente lo que les corresponde seg√∫n sus partes.';

        window.__lastReportText = buildReportText({ enriched, txs: [], totalPaid2, totalParts, unit2 });
        window.__lastReportReady = true;
        return;
      }

      let i = 0, j = 0;
      while (i < debtors.length && j < creditors.length) {
        const d = debtors[i];
        const c = creditors[j];

        const pay = round2(Math.min(d.amount, c.amount));
        if (pay > 0) {
          txs.push({ from: d.name, to: c.name, amount: pay });
          d.amount = round2(d.amount - pay);
          c.amount = round2(c.amount - pay);
        }
        if (d.amount <= 0.004) i++;
        if (c.amount <= 0.004) j++;
      }

      txs.forEach(t => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="left">
            <div class="name">${escapeHTML(t.from)} ‚Üí ${escapeHTML(t.to)}</div>
            <div class="meta">Transferencia recomendada para cuadrar cuentas.</div>
          </div>
          <div class="badge pay">${escapeHTML(fmtEUR(t.amount))}</div>
        `;
        DOM.txList.appendChild(div);
      });

      const remainingDebtors = debtors.reduce((a,d)=>a+d.amount,0);
      const remainingCreditors = creditors.reduce((a,c)=>a+c.amount,0);
      const residue = round2(Math.abs(remainingDebtors - remainingCreditors));

      DOM.txNote.style.display = 'block';
      DOM.txNote.textContent =
        residue <= 0.02
          ? 'Las transferencias propuestas equilibran el grupo (puede haber una diferencia de 1‚Äì2 c√©ntimos por redondeos).'
          : 'Aviso: hay una discrepancia superior a 2 c√©ntimos. Revisa entradas (pagado/partes) por posibles errores.';

      window.__lastReportText = buildReportText({ enriched, txs, totalPaid2, totalParts, unit2 });
      window.__lastReportReady = true;
    }

    // ===============================
    // Guardar + Copiar
    // ===============================
    async function copyToClipboard(text) {
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch (_) {}

      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        ta.style.top = '0';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      } catch (_) {
        return false;
      }
    }

    function downloadTextFile(filename, text) {
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    function normalizeFileName(filename) {
      const defaultName = 'reparto_gastos.tsv';
      let name = (filename == null) ? '' : String(filename).trim();
      if (!name) name = defaultName;
      if (!/\.[a-z0-9]{1,5}$/i.test(name)) name += '.tsv';
      return name;
    }

    async function writeFileInDirectory(dirHandle, filename, text) {
      const okPerm = await verifyDirPermission(dirHandle, 'readwrite');
      if (!okPerm) return false;
      try {
        let fileHandle = getMappedFileHandle(filename);
        if (!fileHandle) {
          fileHandle = await dirHandle.getFileHandle(filename, { create: true });
          setMappedFileHandle(filename, fileHandle);
        }
        const writable = await fileHandle.createWritable();
        await writable.write(text);
        await writable.close();

        // mantener cache sincronizada (m√≠nimo)
        try {
          const f = await fileHandle.getFile();
          setCachedText(filename, text, f.lastModified || Date.now());
        } catch (_) {
          setCachedText(filename, text, Date.now());
        }

        return true;
      } catch (_) {
        return false;
      }
    }

    async function saveAndCopy() {
      if (!window.__lastReportReady) calculate();
      if (!window.__lastReportReady || !window.__lastReportText) {
        DOM.txNote.style.display = 'block';
        DOM.txNote.textContent = 'Primero calcula resultados v√°lidos (revisa nombres/partes/pagado).';
        return;
      }

      let filename = prompt('Nombre del archivo a guardar:', 'reparto_gastos.tsv');
      if (filename === null) return;
      filename = normalizeFileName(filename);

      const copied = await copyToClipboard(window.__lastReportText);

      let savedToFolder = false;
      if (hasFSAccessAPI()) {
        const dir = await ensureDirHandle('Para guardar en la MISMA CARPETA que tu app, selecciona esa carpeta ahora 

(permiso del navegador).');
        if (dir) {
          savedToFolder = await writeFileInDirectory(dir, filename, window.__lastReportText);
        }
      }

      if (!savedToFolder) {
        downloadTextFile(filename, window.__lastReportText);
      }

      const savedOk = upsertSaved(filename, window.__lastReportText);

      DOM.txNote.style.display = 'block';
      if (savedToFolder) {
        DOM.txNote.textContent = copied
          ? `Guardado en la carpeta vinculada como "${filename}" y copiado al portapapeles.`
          : `Guardado en la carpeta vinculada como "${filename}". No se pudo copiar al portapapeles (el navegador puede 

bloquearlo).`;
      } else {
        DOM.txNote.textContent = copied
          ? (savedOk
              ? `Guardado como "${filename}" (descarga), copiado al portapapeles y a√±adido a la lista interna.`
              : `Guardado como "${filename}" (descarga) y copiado al portapapeles.`)
          : (savedOk
              ? `Guardado como "${filename}" (descarga) y a√±adido a la lista interna. No se pudo copiar al portapapeles.`
              : `Guardado como "${filename}" (descarga). No se pudo copiar al portapapeles.`);
      }
    }

    // ===============================
    // Importar / Editar / Borrar
    // ===============================
    function formatSavedMeta(item) {
      if (!item) return 'Selecciona un archivo para ver su contenido.';
      const d = new Date(item.ts || Date.now());
      return `Nombre: ${item.name} ¬∑ Guardado: ${d.toLocaleString('es-ES')} ¬∑ Tama√±o: ${item.text.length} chars`;
    }

    async function listTSVFilesFromDirectory(dirHandle) {
      const okPerm = await verifyDirPermission(dirHandle, 'readwrite');
      if (!okPerm) return [];
      const items = [];
      try {
        window.__dirFileHandleMap = new Map();
        window.__dirFileTextMap = new Map(); // reset cache al listar

        for await (const [name, handle] of dirHandle.entries()) {
          if (handle.kind !== 'file') continue;
          if (!/\.tsv$/i.test(name)) continue;

          setMappedFileHandle(name, handle);

          let ts = Date.now();
          let text = '';
          try {
            const f = await handle.getFile();
            ts = f.lastModified || ts;
            text = await f.text();
          } catch (_) {
            // si no se puede leer, lo dejamos vac√≠o; el UI lo reflejar√°
          }
          setCachedText(name, text, ts);
          items.push({ name, handle, ts });
        }
      } catch (_) {}
      items.sort((a,b)=> (b.ts||0) - (a.ts||0));
      return items;
    }

    // se mantiene por compatibilidad, pero ya no es la v√≠a principal al cambiar selecci√≥n
    async function readFileFromDirectory(dirHandle, filename) {
      const okPerm = await verifyDirPermission(dirHandle, 'readwrite');
      if (!okPerm) return null;
      try {
        let fileHandle = getMappedFileHandle(filename);
        if (!fileHandle) {
          fileHandle = await dirHandle.getFileHandle(filename, { create: false });
          setMappedFileHandle(filename, fileHandle);
        }
        const file = await fileHandle.getFile();
        return { name: filename, text: await file.text(), ts: file.lastModified || Date.now() };
      } catch (_) {
        return null;
      }
    }

    async function writeFileEditsInDirectory(dirHandle, filename, text) {
      return writeFileInDirectory(dirHandle, filename, text);
    }

    async function deleteFileInDirectory(dirHandle, filename) {
      const okPerm = await verifyDirPermission(dirHandle, 'readwrite');
      if (!okPerm) return false;
      try {
        await dirHandle.removeEntry(filename);
        deleteMappedFileHandle(filename);
        deleteCachedText(filename);
        return true;
      } catch (_) {
        return false;
      }
    }

    async function refreshSavedList(selectNameToKeep = null) {
      DOM.savedSelect.innerHTML = '';
      DOM.savedEditor.value = '';
      DOM.savedMeta.textContent = 'Selecciona un archivo para ver su contenido.';

      if (hasFSAccessAPI()) {
        const dir = await ensureDirHandle('Para importar desde la MISMA CARPETA que tu app, selecciona esa carpeta ahora 

(permiso del navegador).');
        if (dir) {
          const files = await listTSVFilesFromDirectory(dir);
          DOM.savedCount.textContent = String(files.length);

          if (files.length === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = '(No hay .tsv en la carpeta vinculada)';
            DOM.savedSelect.appendChild(opt);
            DOM.savedSelect.disabled = true;
            DOM.savedMeta.textContent = 'No hay archivos .tsv en la carpeta vinculada. Guarda uno primero con ‚ÄúGuardar + 

Copiar‚Äù.';
            return;
          }

          DOM.savedSelect.disabled = false;
          files.forEach(it => {
            const opt = document.createElement('option');
            opt.value = it.name;
            const d = new Date(it.ts || Date.now());
            opt.textContent = `${it.name} ¬∑ ${d.toLocaleDateString('es-ES')}`;
            DOM.savedSelect.appendChild(opt);
          });

          let toSelect = selectNameToKeep;
          if (!toSelect || !files.some(x => x.name === toSelect)) toSelect = files[0].name;
          DOM.savedSelect.value = toSelect;

          // ====== usa cache (sin re-leer del FS) ======
          const cached = getCachedText(toSelect);
          if (cached && typeof cached.text === 'string') {
            DOM.savedEditor.value = cached.text;
            DOM.savedMeta.textContent = formatSavedMeta({ name: toSelect, text: cached.text, ts: cached.ts });
          } else {
            DOM.savedMeta.textContent = 'No se pudo leer el archivo seleccionado.';
          }
          return;
        }
      }

      const items = loadSavedIndex();
      DOM.savedCount.textContent = String(items.length);

      if (items.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '(No hay archivos guardados)';
        DOM.savedSelect.appendChild(opt);
        DOM.savedSelect.disabled = true;
        DOM.savedMeta.textContent = 'No hay archivos guardados todav√≠a. Usa ‚ÄúGuardar + Copiar‚Äù para crear uno.';
        return;
      }

      DOM.savedSelect.disabled = false;
      items.forEach(it => {
        const opt = document.createElement('option');
        opt.value = it.name;
        const d = new Date(it.ts || Date.now());
        opt.textContent = `${it.name} ¬∑ ${d.toLocaleDateString('es-ES')}`;
        DOM.savedSelect.appendChild(opt);
      });

      let toSelect = selectNameToKeep;
      if (!toSelect || !items.some(x => x.name === toSelect)) toSelect = items[0].name;
      DOM.savedSelect.value = toSelect;

      const current = getSavedByName(toSelect);
      DOM.savedEditor.value = current ? current.text : '';
      DOM.savedMeta.textContent = formatSavedMeta(current);
    }

    function openImportDialog() {
      (async () => {
        await refreshSavedList();
        if (typeof DOM.importDlg.showModal === 'function') {
          DOM.importDlg.showModal();
        } else {
          DOM.txNote.style.display = 'block';
          DOM.txNote.textContent = 'Este navegador no soporta di√°logos modales. Prueba con Chrome/Edge.';
        }
      })();
    }

    function closeImportDialog() {
      try { DOM.importDlg.close(); } catch (_) {}
    }

    function parseParticipantsFromReport(text) {
      const lines = String(text || '').split(/\r?\n/);
      let start = lines.findIndex(l => l.trim() === 'RESULTADOS_POR_PARTICIPANTE');
      if (start < 0) return null;

      let i = start + 2;
      const out = [];
      for (; i < lines.length; i++) {
        const line = lines[i];
        if (!line) break;
        const trimmed = line.trim();
        if (!trimmed) break;
        if (trimmed === 'QUIEN_PAGA_A_QUIEN') break;
        if (trimmed.startsWith('#')) continue;

        const cols = line.split('\t');
        if (cols.length < 3) continue;

        const name = (cols[0] || '').trim();
        const parts = parseNum(cols[1] || '');
        const paid = parseNum(cols[2] || '');

        if (!name) continue;
        if (!Number.isFinite(parts) || parts <= 0) continue;
        if (!Number.isFinite(paid) || paid < 0) continue;

        out.push({ name, parts: Math.round(parts), paid: round2(paid) });
      }
      return out.length ? out : null;
    }

    async function loadSelectedSavedToEditor() {
      const name = DOM.savedSelect.value;
      if (!name) return;

      // ====== prioridad: cache de carpeta (si existe) ======
      const cached = getCachedText(name);
      if (cached && typeof cached.text === 'string') {
        DOM.savedEditor.value = cached.text;
        DOM.savedMeta.textContent = formatSavedMeta({ name, text: cached.text, ts: cached.ts });
        return;
      }

      // fallback antiguo (por si vienes de localStorage)
      const item = getSavedByName(name);
      DOM.savedEditor.value = item ? item.text : '';
      DOM.savedMeta.textContent = formatSavedMeta(item);
    }

    async function saveEditorEdits() {
      const name = DOM.savedSelect.value;
      if (!name) return;

      const newText = DOM.savedEditor.value || '';

      if (hasFSAccessAPI()) {
        const dir = await ensureDirHandle('Para guardar cambios en la carpeta, selecciona la carpeta vinculada.');
        if (dir) {
          const ok = await writeFileEditsInDirectory(dir, name, newText);
          DOM.savedMeta.textContent = ok
            ? formatSavedMeta({ name, text: newText, ts: Date.now() })
            : 'No se pudo guardar cambios en la carpeta (permiso o error).';
          if (ok) await refreshSavedList(name);
          return;
        }
      }

      const ok = upsertSaved(name, newText);
      DOM.savedMeta.textContent = ok
        ? formatSavedMeta(getSavedByName(name))
        : 'No se pudo guardar (almacenamiento local lleno o bloqueado).';
      if (ok) await refreshSavedList(name);
    }

    async function deleteSelectedSaved() {
      const name = DOM.savedSelect.value;
      if (!name) return;

      const okConfirm = confirm(`¬øSeguro que quieres borrar "${name}"?`);
      if (!okConfirm) return;

      if (hasFSAccessAPI()) {
        const dir = await ensureDirHandle('Para borrar en la carpeta, selecciona la carpeta vinculada.');
        if (dir) {
          const ok = await deleteFileInDirectory(dir, name);
          if (!ok) {
            DOM.savedMeta.textContent = 'No se pudo borrar el archivo en la carpeta (permiso o error).';
            return;
          }
          await refreshSavedList();
          return;
        }
      }

      deleteSaved(name);
      await refreshSavedList();
    }

    async function loadSelectedSavedIntoApp() {
      const name = DOM.savedSelect.value;
      if (!name) return;

      // Fuente principal: el editor (ya est√° sincronizado por selecci√≥n)
      let text = (DOM.savedEditor && typeof DOM.savedEditor.value === 'string') ? DOM.savedEditor.value : null;
      if (text != null) {
        text = String(text);
        if (text.trim().length === 0) text = null;
      }

      // Fallback: cache de carpeta
      if (text == null) {
        const cached = getCachedText(name);
        if (cached && typeof cached.text === 'string' && cached.text.trim().length) text = cached.text;
      }

      // Fallback final: localStorage
      if (text == null) {
        const item = getSavedByName(name);
        if (item) text = item.text;
      }

      if (text == null) {
        DOM.savedMeta.textContent = 'No se pudo leer el archivo seleccionado.';
        return;
      }

      const rows = parseParticipantsFromReport(text);
      if (!rows) {
        DOM.savedMeta.textContent = 'No se pudo restaurar participantes (formato no reconocido). Puedes editar el texto o 

guardar uno nuevo.';
        return;
      }

      DOM.tbody.innerHTML = '';
      clearOutputs();
      rows.forEach(r => addRow({ name: r.name, parts: r.parts, paid: r.paid }));
      updateCount();

      closeImportDialog();

      DOM.txNote.style.display = 'block';
      DOM.txNote.textContent = `Cargado "${name}" en la app. Ahora puedes editar y volver a calcular.`;
    }

    // ===============================
    // Eventos
    // ===============================
    DOM.btnAdd.addEventListener('click', () => addRow({name:'', parts:1, paid:0}));
    DOM.btnCalc.addEventListener('click', calculate);
    DOM.btnSaveCopy.addEventListener('click', saveAndCopy);
    DOM.btnImport.addEventListener('click', openImportDialog);
    DOM.btnReset.addEventListener('click', resetAll);

    DOM.btnCloseImport.addEventListener('click', closeImportDialog);
    DOM.savedSelect.addEventListener('change', () => { loadSelectedSavedToEditor(); });
    DOM.btnSaveEdits.addEventListener('click', () => { saveEditorEdits(); });
    DOM.btnDeleteSaved.addEventListener('click', () => { deleteSelectedSaved(); });
    DOM.btnLoadToApp.addEventListener('click', () => { loadSelectedSavedIntoApp(); });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (DOM.importDlg && DOM.importDlg.open) closeImportDialog();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const el = document.activeElement;
        if (el && el.tagName === 'INPUT') {
          e.preventDefault();
          calculate();
        }
      }
    });

    // Init
    resetAll();
  </script>
</body>
</html>
